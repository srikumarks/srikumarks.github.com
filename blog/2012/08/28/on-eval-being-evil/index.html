
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>On eval and evil. - Codaholic</title>
  <meta name="author" content="Srikumar">

  
  <meta name="description" content="">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://srikumarks.github.com/blog/2012/08/28/on-eval-being-evil/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Codaholic" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cantata+One' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37337144-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Codaholic</a></h1>
  
    <h2>Does the dog have Turing nature?</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:srikumarks.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/srikumarks">Github</a></li>
  <li><a href="/demos">Demos</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">On Eval and Evil.</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-28T00:00:00+05:30" pubdate data-updated="true">Aug 28<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>&#8220;eval is evil&#8221; has become a maxim repeated in the Javascript community.
Douglas Crockford, in <a href="http://shop.oreilly.com/product/9780596517748.do">Javascript: The Good Parts</a>, rightly advises against
hidden and explicit uses of eval for security and clarity reasons. Now, I find
<code>eval</code> useful to implement <a href="/gyan/2012/04/14/creating-dsls-in-javascript-using-j-expressions/">DSLs in Javascript</a>. The in-browser <a href="http://coffeescript.org">CoffeeScript</a>
compiler wouldn&#8217;t be possible without <code>eval</code> (directly or indirectly). So, in
this post, I wish to explore what appears interesting about <code>eval</code> that is
relevant to building such DSLs.</p>

<!-- more -->


<p>For this post, I&#8217;ll stick to the behaviour of <code>eval</code> in the <strong>Chrome</strong> browser
(i.e. the V8 engine, which also applies to <a href="http://nodejs.org">Node.js</a>). We&#8217;ll go through a
number of contexts and examine how <code>eval</code> behaves in each of those. You can
copy paste the code shown here to Chrome&#8217;s JS console and run them.</p>

<h2>What is <code>eval</code>?</h2>

<p>A simplistic description is that you pass a Javascript string to <code>eval</code> and it
will &#8220;evaluate&#8221; it as Javascript code, whatever that means. The <a href="http://www.ecma-international.org/publications/standards/Ecma-262.htm">ECMA-262</a>
specification (edition 5.1) has the following to say on <code>eval</code> -</p>

<blockquote><p><strong>10.4.2 Entering Eval Code</strong></p>

<p>The following steps are performed when control enters the execution context for
eval code:</p>

<ol>
<li><p>If there is no calling context or if the eval code is not being evaluated by
a direct call (15.1.2.1.1) to the eval function then,</p>

<p> a. Initialise the execution context as if it was a global execution context
 using the eval code as C as described in 10.4.1.1.</p></li>
<li><p>Else,</p>

<p> a. Set the <code>ThisBinding</code> to the same value as the <code>ThisBinding</code> of the calling
 execution context.</p>

<p> b. Set the LexicalEnvironment to the same value as the <code>LexicalEnvironment</code>
 of the calling execution context.</p>

<p> c. Set the <code>VariableEnvironment</code> to the same value as the <code>VariableEnvironment</code>
 of the calling execution context.</p></li>
<li><p>If the eval code is strict code, then</p>

<p> a. Let <code>strictVarEnv</code> be the result of calling <code>NewDeclarativeEnvironment</code>
 passing the <code>LexicalEnvironment</code> as the argument.</p>

<p> b. Set the <code>LexicalEnvironment</code> to <code>strictVarEnv</code>.</p>

<p> c. Set the <code>VariableEnvironment</code> to <code>strictVarEnv</code>.</p></li>
<li><p>Perform <em>Declaration Binding Instantiation</em> as described in 10.5 using the
eval code.</p></li>
</ol>


<p><strong>10.4.2.1 Strict Mode Restrictions</strong></p>

<p>The eval code cannot instantiate variable or function bindings in the variable
environment of the calling context that invoked the eval if either the code of
the calling context or the eval code is strict code. Instead such bindings are
instantiated in a new VariableEnvironment that is only accessible to the eval
code.</p></blockquote>

<h2>Introducing local variables</h2>

<p>An expression of the form <code>eval("var x = 10;")</code> is capable of introducing a new
variable <code>x</code> in the context in which it is executed. However, as noted in the
ECMA specification, if the eval code is strict, then you cannot introduce a new
variable this way - i.e. <code>eval("var x = 10;")</code> will work, but
<code>eval('"use strict"; var x = 10;')</code> will not work. No exception is thrown, but the
variable is simply not introduced into the enclosing environment, though it is
available to the rest of the evaled code.</p>

<p>Consider the following function -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">localVars</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">stmt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">eval</span><span class="p">(</span><span class="nx">stmt</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>All of the following behave as one might expect -</p>

<ol>
<li><code>localVars(10, "var y = 5;")</code> returns <code>15</code></li>
<li><code>localVars(10, "var y = x + 5;")</code> returns <code>25</code>.</li>
<li><code>localVars(10, "'use strict'; var y = 5;")</code> raises a <code>ReferenceError: y is not defined</code> exception.</li>
</ol>


<h2>Capturing local variables in closures</h2>

<p>Consider the following function -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">captureSecretValue</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">secret</span> <span class="o">=</span> <span class="mf">3.14159</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>captureSecretValue("secret")</code> returns <code>3.14159</code> as expected. You can also
create closures that capture the &#8220;secret&#8221; value -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">captureSecretValue</span><span class="p">(</span><span class="s2">&quot;(function (x) { return secret * x; })&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span> <span class="c1">// prints &quot;3.14159&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, the following gives a <code>ReferenceError</code> -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">nest</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">nestedSecret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">captureNestedSecret</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">nest</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">secret</span> <span class="o">=</span> <span class="mf">3.14159</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">nest</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">captureNestedSecret</span><span class="p">(</span><span class="s2">&quot;secret * nestedSecret&quot;</span><span class="p">,</span> <span class="nx">nest</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>This illustrates that only the variables in the <em>lexical</em> context are available
to <code>eval</code> and not those in its <em>evaluation</em> context. The following will
therefore print <code>6.28318</code> as expected.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">captureNestedSecret</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">secret</span> <span class="o">=</span> <span class="mf">3.14159</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">nest</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">nestedSecret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">nest</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">captureNestedSecret</span><span class="p">(</span><span class="s2">&quot;secret * nestedSecret&quot;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Scope objects</h2>

<p>If you have an object whose keys give variable names and whose values give their values,
you can use <code>eval</code> in conjunction with the <code>with</code> statement (beware: evil squared!) to evaluate
code in that scope. Here is what I mean -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">evalInScope</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">with</span> <span class="p">(</span><span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">20</span><span class="p">};</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">evalInScope</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="s2">&quot;a + b&quot;</span><span class="p">));</span> <span class="c1">// prints &quot;30&quot;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">evalInScope</span><span class="p">(</span><span class="nb">Math</span><span class="p">,</span> <span class="s2">&quot;acos(0)&quot;</span><span class="p">));</span> <span class="c1">// prints &quot;1.5707963267948966&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>What is more interesting is that you can capture the &#8220;variables&#8221; in a closure
that you create using eval as follows -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">evalInScope</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="s2">&quot;(function (c) { return a + b * c; })&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span> <span class="c1">// prints &quot;10&quot;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// prints &quot;50&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since it is not the <em>values</em> of the variables that are being captured, but
the <em>references</em>, you can now do -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">scope</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span> <span class="c1">// prints &quot;100&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you subsequently delete one of the variables in the <code>scope</code> object, you get
a <code>ReferenceError</code> as one might expect. The <code>scope</code> object therefore provides
access to the scope chain of the created closure. This interception is deep,
since you can introduce new variables into the scope by manipulating <code>scope</code>
as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">10</span><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">evalInScope</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="s2">&quot;(function (c) { return a + b * c; })&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>  <span class="c1">// ReferenceError</span>
</span><span class='line'><span class="nx">scope</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>       <span class="c1">// Introduce binding for &quot;b&quot;.</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>  <span class="c1">// prints &quot;10&quot;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>  <span class="c1">// prints &quot;50&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Named functions within <code>with</code></h3>

<p>The following code doesn&#8217;t work and throws a <code>ReferenceError</code> because
the <code>inner</code> closure is instantiated outside the <code>with</code> scope by the V8
compiler, contrary to what it might look like.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// (1) doesn&#39;t work</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;hello world&quot;</span><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">greeting</span><span class="p">;</span>
</span><span class='line'><span class="kd">with</span> <span class="p">(</span><span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">inner</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">greeting</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">inner</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following alternative works in V8 because the closure is <em>created</em>
when executing a statement within the <code>with</code> clause.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// (2) works</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;hello world&quot;</span><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">greeting</span><span class="p">;</span>
</span><span class='line'><span class="kd">with</span> <span class="p">(</span><span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">inner</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">greeting</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">inner</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This difference can be a WTF and points to the general recommendation of only
using the latter &#8220;name a function through assignment&#8221; approach. We know that
the definitions of named functions are lifted to the top of the surrounding
scope, but also know that they are lifted out of any surrounding <code>with</code> blocks
as well.</p>

<blockquote><p><strong>Update</strong>: This inconsistency is a bug in V8 looks like. Firefox&#8217;s VM
behaves consistently in both the cases above. I&#8217;ve submitted a <a href="https://code.google.com/p/v8/issues/detail?id=2311">V8 bug report</a>
for this problem.</p></blockquote>

<h2>Preventing access to global objects</h2>

<p>In a browser environment, all global symbols are available as properties of the
<code>window</code> object. We can use this, in conjunction with the &#8220;scope object&#8221;
feature as discussed above, to evaluate code that is to be prevented from
touching any of these global objects or classes. This gives us a poor man&#8217;s
sandbox.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">;(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">poorMansSandbox</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">makeSandbox</span><span class="p">,</span> <span class="nx">world</span><span class="p">,</span> <span class="nx">allowed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Makes obj and all its ancestors read-only.</span>
</span><span class='line'>        <span class="kd">function</span> <span class="nx">freezeHard</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span> <span class="nx">iter</span><span class="p">;</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">iter</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">try</span> <span class="p">{</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">iter</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">scope</span><span class="p">,</span> <span class="nx">sandbox</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Make poorMansSandbox itself unavailable.</span>
</span><span class='line'>            <span class="nx">scope</span> <span class="o">=</span> <span class="p">{</span><span class="nx">poorMansSandbox</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Mask every global thing visible, except &quot;allowed&quot;.</span>
</span><span class='line'>            <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="nx">world</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">scope</span><span class="p">[</span><span class="nx">g</span><span class="p">]</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">allowed</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">scope</span><span class="p">[</span><span class="nx">g</span><span class="p">]</span> <span class="o">=</span> <span class="nx">freezeHard</span><span class="p">(</span><span class="nx">world</span><span class="p">[</span><span class="nx">g</span><span class="p">]);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">freezeHard</span><span class="p">(</span><span class="nx">scope</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">sandbox</span> <span class="o">=</span> <span class="nx">makeSandbox</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">scope</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}());</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Call the sandboxer with no arguments to</span>
</span><span class='line'>                <span class="c1">// force it to update its world state.</span>
</span><span class='line'>                <span class="nx">update</span><span class="p">();</span>
</span><span class='line'>                <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="nx">sandbox</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}(</span>  <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">with</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>                <span class="p">};</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}),</span>
</span><span class='line'>        <span class="k">this</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="s2">&quot;Math&quot;</span><span class="p">,</span> <span class="s2">&quot;Object&quot;</span><span class="p">,</span> <span class="s2">&quot;Array&quot;</span><span class="p">,</span> <span class="s2">&quot;Function&quot;</span><span class="p">,</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Boolean&quot;</span><span class="p">,</span> <span class="s2">&quot;Infinity&quot;</span><span class="p">,</span> <span class="s2">&quot;NaN&quot;</span><span class="p">,</span> <span class="s2">&quot;isNaN&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="s2">&quot;isFinite&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">));</span>
</span><span class='line'><span class="p">}());</span>
</span></code></pre></td></tr></table></div></figure>


<p>The idea behind the above code is to prevent access to global properties
other than the ones given in the <code>allowed</code> array. Furthermore, we also
don&#8217;t want the eval code to add new global properties by simple assignment,
for which we simply use strict mode evaluation.</p>

<p>Though this prevents access to existing global properties, it doesn&#8217;t prevent
access to properties that will be added to <code>window</code> <em>after</em> the <code>eval</code> happens.
To update the internal <code>scope</code> object of the <code>poorMansSandbox</code>, call it
once with no arguments before calling it on the string to be evaluated.</p>

<p>Of course, the eval-ed code can still do malicious things, but it cannot
at least do them inadvertently. Hence &#8220;poor man&#8217;s&#8221;.</p>

<h2>Conclusion</h2>

<p><code>eval</code> should be used with tons of caution. However, if you&#8217;re interested in
making DSLs around Javascript, it helps to know its workings a bit deeper.
Remember - there is always something &#8220;good&#8221; in every &#8220;evil&#8221; ;)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Srikumar</span></span>

      








  


<time datetime="2012-08-28T00:00:00+05:30" pubdate data-updated="true">Aug 28<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/javascript/'>Javascript</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://srikumarks.github.com/blog/2012/08/28/on-eval-being-evil/" data-via="srikumarks" data-counturl="http://srikumarks.github.com/blog/2012/08/28/on-eval-being-evil/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/04/30/toy-language-using-j-expressions/" title="Previous Post: Toy language using j-expressions">&laquo; Toy language using j-expressions</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/11/09/a-critique-of-tuna/" title="Next Post: A critique of Tuna">A critique of Tuna &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/30/taming-the-scriptprocessornode/">Taming the ScriptProcessorNode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/30/exploring-grha-bhedams/">Exploring graha bhedams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/27/scratch-pad-for-text-with-diacritics/">Scratch pad for text with diacritics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/09/a-critique-of-tuna/">A critique of Tuna</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/28/on-eval-being-evil/">On eval and evil.</a>
      </li>
    
  </ul>
</section>

<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/102694714835839603248?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("srikumarks", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/srikumarks" class="twitter-follow-button" data-show-count="false">Follow @srikumarks</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Srikumar -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
