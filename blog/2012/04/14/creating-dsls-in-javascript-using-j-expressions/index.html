
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Creating DSLs in Javascript using J-expressions - Codaholic</title>
  <meta name="author" content="Srikumar">

  
  <meta name="description" content="">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://srikumarks.github.com/blog/2012/04/14/creating-dsls-in-javascript-using-j-expressions/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Codaholic" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cantata+One' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37337144-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Codaholic</a></h1>
  
    <h2>Does the dog have Turing nature?</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:srikumarks.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/srikumarks">Github</a></li>
  <li><a href="/demos">Demos</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Creating DSLs in Javascript Using J-expressions</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-14T00:00:00+08:00" pubdate data-updated="true">Apr 14<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Scheme and Lisp have for long had powerful meta-programming abilities due to
the syntax of their language being the same as the syntax for the main data
structure supported by the language - the humble list. These languages are
therefore well suited for inventing smaller special purpose &#8220;domain specific
languages.</p>

<p>Javascript, on the other hand, has a &#8220;full blown syntax&#8221; that makes
meta-programming not for the faint of heart. One consequence of the lack of
such ability is that developers have not had the benefit of the abstraction
possible through small special purpose DSLs.</p>

<p>Here, I outline an approach for creating DSLs in Javascript using the now
prevalent <a href="http://www.json.org">JSON</a> format that is native to the language. The initial part tries
to explain the kinds of scenarios in which one might consider building a DSL,
which is important to have an idea about. Later, I get into the actual
representation using JSON.</p>

<!-- more -->


<h2>When to make a DSL? .. or &#8220;Hunting of the Closure&#8221;.</h2>

<p>Under normal circumstances, you should consider developing your abstractions as
&#8220;modules&#8221;. Modules (or &#8220;libraries&#8221;) offer basic encapsulation and hiding
facilities that JS developers are familiar with. You can help them benefit from
your work by leveraging that familiarity.</p>

<p>On the rare occasion though, you might find yourself writing code that starts
looking like a small &#8220;compiler&#8221;  or &#8220;runtime&#8221;. In such circumstances, creating
a DSL for that part of the system might be worthwhile to consider &#8211; the purpose,
again, being that it might ease the job of those that your package targets.</p>

<p>A tipping point can happen when you discover that you are working with a
category of objects that are &#8220;closed over&#8221; a suite of operations.  In
mathematics, a set of objects is said to be &#8220;closed&#8221; with respect to a function
if the function maps objects of the set to other objects in the same set and we
say the set &#8220;has the closure property&#8221;. But before we get to why that&#8217;s
significant, let&#8217;s take a quick look at a simple example.</p>

<h3>The &#8220;closure property&#8221; - an example</h3>

<p>Say we want a framework to create and render visuals that vary in time &#8211; like,
maybe, umm &#8230; a video? Here is a simple representation of such a visual, which
we&#8217;ll call a &#8220;show&#8221;  -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">show</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// calculate...</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">image</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Given such a &#8220;show&#8221;, it is trivial to write a renderer for it -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">show</span><span class="p">,</span> <span class="nx">duration_ms</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">startTime_ms</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">startTime_ms</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">context</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">show</span><span class="p">(</span><span class="nx">t</span><span class="p">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">duration_ms</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, I want an operator which will delay a given show by a specified amount
of time. Simple -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">show</span><span class="p">,</span> <span class="nx">dt_ms</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">show</span><span class="p">(</span><span class="nx">t</span> <span class="o">-</span> <span class="nx">dt_ms</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>How about a &#8220;cut&#8221; from one show to another at a given time. Also simple -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">cut</span><span class="p">(</span><span class="nx">when</span><span class="p">,</span> <span class="nx">show1</span><span class="p">,</span> <span class="nx">show2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">when</span> <span class="o">?</span> <span class="nx">show1</span> <span class="o">:</span> <span class="nx">show2</span><span class="p">)(</span><span class="nx">t</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, if we represent video clips using such <code>show</code>s, those two functions under
which the set of <code>show</code>s is closed give us all we need to make an edited
production &#8230;. because we can combine them.  Note that <code>delay</code> takes a show
and produces a show, and so does <code>cut</code> &#8230; which takes <em>two</em> shows, yes, but
that&#8217;s the same idea. This kind of combinatorial power is valuable when
modelling a domain.</p>

<blockquote><h5>ShowTime</h5>

<p>The interface to <a href="http://www.muvee.com">muvee Reveal</a>&#8217;s rendering engine &#8220;ShowTime&#8221; is built
around this kind of an abstraction. The details of <a href="http://muvee-style-authoring.googlecode.com/svn/doc/main/ShowTime_-_the_muvee_timeline.html">ShowTime</a> and the DSL for
<a href="http://muvee-style-authoring.googlecode.com">authoring muvee&#8217;s &#8220;styles&#8221;</a> built on top of this API are available publicly.
In this case, the DSL abstracts away implementation details such as the deep
nesting of functions that might result in a naive implementation.</p></blockquote>

<h2>Functions are closed under composition</h2>

<p>Here is what makes the closure property worth hunting for &#8211;</p>

<blockquote><p>When you have several functions under which your set is closed, it is also
closed under <em>arbitrary compositions</em> of these functions.</p></blockquote>

<p>So, well, why bother with a DSL? Why not just use function composition?  One
reason is that, in the real world, your set is closed with respect to each of
these functions <em>only under certain constraints</em>. These constraints might make
it difficult to predict whether a given composition of these functions is a
valid operation in your domain. You will need to validate a composition
<em>before</em> you begin to act on it, which becomes difficult if you only have
access to the composition and not the parts. A DSL that abstracts over these
constraints by exposing only that subset of compositions that are valid in the
domain would therefore be of great help to people reusing your work.</p>

<blockquote><p>The DSL&#8217;s purpose, then, is to hide the constraints under which closure is
possible and composition operations are valid - i.e. where composition and
use are context sensitive.</p></blockquote>

<h2>A DSL for asynchronous operations</h2>

<p>Let&#8217;s consider an example where having a DSL seems beneficial - composing
asynchronous operations.</p>

<p>It is a common convention for a function that does some asynchronous action to
accept &#8220;callback&#8221; and &#8220;errback&#8221; functions to call when it succeeds or fails
respectively.  Composing such actions into sequences soon turns into what is
usually referred to as &#8220;callback hell&#8221; and the person reading the source soon
looses sight of the whole flow of control.</p>

<p>So, do we satisfy our &#8220;DSL criteria&#8221; here?</p>

<ol>
<li>Closure property? CHECK. A sequence of operations is itself an operation.</li>
<li>Constraints? CHECK. A sequence is allowed to proceed normally only when an
operation doesn&#8217;t fail. There are many error handling strategies when an
operation fails and we may not have seen all of them yet.</li>
</ol>


<p>Let&#8217;s then make a small DSL for sequencing asynchronous operations.</p>

<h2>Representing asynchronous operations</h2>

<p>First we&#8217;re going to need a way to define new asynchonous operations
in plain Javascript for our &#8220;primitives&#8221;. A simple representation is
to model an async operation (let&#8217;s call them &#8220;asop&#8221;s for convenience)
as a function that takes a specific set of arguments as follows &#8211;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">asop</span><span class="p">(</span><span class="nx">M</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="c1">// we&#39;re good.</span>
</span><span class='line'>    <span class="nx">M</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">M</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span> <span class="nx">M</span><span class="p">.</span><span class="nx">failure</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Something bad happened</span>
</span><span class='line'>    <span class="nx">M</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">failure</span><span class="p">,</span> <span class="nx">M</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">),</span> <span class="nx">M</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span> <span class="nx">M</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function takes four parameters -</p>

<ol>
<li><code>M</code> is a module that provides facilities for starting an asop &#8211;
<code>M.start</code> and a terminal operation <code>M.end</code> that does nothing and stops all
processing.</li>
<li><code>input</code> is the data being passed to the asop to do its job.</li>
<li><code>success</code> is an asop to start once this asop finishes
successfully.</li>
<li><code>failure</code> is an asop to start if this asop cannot be completed for
some reason.</li>
</ol>


<blockquote><p>Note that an asop is recursively defined in terms of and makes use of two
other asops <code>success</code> and <code>failure</code>, which themselves have the <em>same</em>
function signature.</p></blockquote>

<p>We take <code>M.error</code> to be a utility that produces an error object that captures
the current error state to pass to the failure operation. Here is a simple
definition for <code>M</code> &#8211;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">M</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">succ</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">op</span><span class="p">(</span><span class="nx">M</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">succ</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="nx">M</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">descr</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">succ</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">({</span><span class="nx">descr</span><span class="o">:</span> <span class="nx">descr</span><span class="p">,</span> <span class="nx">input</span><span class="o">:</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">success</span><span class="o">:</span> <span class="nx">succ</span><span class="p">,</span> <span class="nx">failure</span><span class="o">:</span> <span class="nx">fail</span><span class="p">});</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="nx">M</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sequencing two operations</h2>

<p>Since our operations are ordinary functions, we can write a &#8220;sequencing operator&#8221;
for combining two operations as a higher order function as follows &#8211;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">seq</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">M</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">M</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">seq</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">success</span><span class="p">),</span> <span class="nx">failure</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note</em>: This looks like infinite recursion, but it will terminate automatically
when <code>M.end</code> is passed for <code>next</code> because, we define <code>M.end</code> to be the operation
that doesn&#8217;t continue further.</p>

<h2>Making a chain of operations</h2>

<p>The humble <code>seq</code> operator can now be put to use to chain an arbitrary
number of operations given as an array &#8212;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">chain</span><span class="p">(</span><span class="nx">operations</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">revOps</span> <span class="o">=</span> <span class="nx">operations</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">reverse</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">M</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">M</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">revOps</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">seq</span><span class="p">,</span> <span class="nx">success</span><span class="p">),</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">M</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span> <span class="nx">failure</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Umm &#8230; why do we need a DSL again?</h2>

<p>You&#8217;d be right in asking that question. So far, it looks like the language is
expressive enough to let us code up all these compositions using plain higher
order functions. So, let me throw something into the mix that might cause you
to stumble if you think such functions alone are adequate.</p>

<p>Consider the exchanges that happen between a web server and a client (browser).
A client instructs a web server to perform some operation, the server gets back
when done, or with progress notifications, then the client does a few async things
like store some data locally, and then makes the next request and so on. The ability
to represent a <em>sequence</em> of actions directly is a boon to take care of all these
exchanges happening between these two dance partners.</p>

<blockquote><h3>So here is your task - ###</h3>

<p>Abstract away the transaction to survive a termination of connection with the
server. I&#8217;m not talking packet loss here.  I&#8217;m talking about the user
initiating a series of operations and in the middle of things shutting down
the browser. What I want to happen is for the operations to continue exactly
from wherever they left off &#8211; because I cannot &#8220;throw an exception&#8221; and undo
a rocket launch. If the client was waiting for a response from the server, it
should again start waiting for that response; and by implication if the
server was doing something and found out that the connection had terminated
at the &#8220;next&#8221; step, it should&#8217;ve stored away whatever it needed to do to
continue, and must resume that when the user connects again, maybe after some
mild handshaking. In particular, it is <em>not</em> acceptable to terminate the
operation sequence just because the browser was closed.</p></blockquote>

<p>Trying to do something like this is where reifying processes as functions
breaks down. To a lisp/scheme programmer, a solution would already be in sight
&#8211; use s-expressions to represent operations and store away instructions in
that form. What might we do in the Javascript world?</p>

<h2>J expressions</h2>

<p>The image I have in my mind now is Douglas Crockford standing with legs apart,
arms folded, cape flying with a speech bubble pointing to his head saying
&#8220;JSON to the rescue!&#8221;.</p>

<p>Since we have our framework taking care of coordinating the success and failure
of operations, all it takes to <em>specify</em> an operation, given a known set of
named &#8220;primitive&#8221; operations, are the following &#8211;</p>

<ol>
<li>The <em>name</em> of the operation to start.</li>
<li>An <em>input</em> object to customize any details of the operation.</li>
</ol>


<p>So, there you go, we can change our representation of an operation from being
a function to something that looks like -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span><span class="nx">opname</span><span class="o">:</span> <span class="nx">input_object</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Technically, that&#8217;ll be <code>{"opname": input_object}</code> in JSON, but let&#8217;s ignore
that difference since it is <em>serializable</em> using JSON, which is what&#8217;s
important.)</p>

<p>The input object is also a literal or computed <em>value</em> which we restrict to
JSON-serializable values. The named primitive operation can itself be provided
in a module as a function that takes the whole spec object and does what it is
supposed to do.</p>

<p>We can now specify a series of operations as an array in this form -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span><span class="k">do</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span><span class="nx">ask</span><span class="o">:</span> <span class="s2">&quot;Enter file name: &quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;file&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="nx">fetchFile</span><span class="o">:</span> <span class="p">{</span><span class="nx">showProgress</span><span class="o">:</span> <span class="s2">&quot;progress_bar&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="nx">reportInterval</span><span class="o">:</span> <span class="mf">1.0</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="nx">spawn</span><span class="o">:</span> <span class="p">{</span><span class="nx">withRetry</span><span class="o">:</span> <span class="p">{</span><span class="nx">uploadToDropbox</span><span class="o">:</span> <span class="p">{</span><span class="nx">user</span><span class="o">:</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;meow&quot;</span><span class="p">}},</span>
</span><span class='line'>                <span class="nx">maxTries</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>                  <span class="nx">onfail</span><span class="o">:</span> <span class="p">{</span><span class="k">do</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>                            <span class="p">{</span><span class="nx">deleteTempFiles</span><span class="o">:</span> <span class="kc">null</span><span class="p">},</span>
</span><span class='line'>                            <span class="p">{</span><span class="nx">ask</span><span class="o">:</span> <span class="s2">&quot;Dropbox upload failed. Try again?&quot;</span><span class="p">,</span>
</span><span class='line'>                                <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;yes/no&quot;</span><span class="p">,</span>
</span><span class='line'>                                 <span class="nx">yes</span><span class="o">:</span> <span class="p">{</span><span class="nx">retry</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span>
</span><span class='line'>                                  <span class="nx">no</span><span class="o">:</span> <span class="p">{</span><span class="nx">raise</span><span class="o">:</span> <span class="s2">&quot;Give up&quot;</span><span class="p">}}</span>
</span><span class='line'>                            <span class="p">]}}},</span>
</span><span class='line'>    <span class="p">{</span><span class="nx">cacheInLocalStore</span><span class="o">:</span> <span class="s2">&quot;prefix&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="nx">showInElement</span><span class="o">:</span> <span class="s2">&quot;element_id&quot;</span><span class="p">}</span>
</span><span class='line'><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we are given the primitive operations as members of a module <code>M</code>, we can run
a primitive operation as follows -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">runPrimitiveOperation</span><span class="p">(</span><span class="nx">opspec</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">M</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">opname</span> <span class="k">in</span> <span class="nx">opspec</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">M</span><span class="p">[</span><span class="nx">opname</span><span class="p">](</span><span class="nx">M</span><span class="p">,</span> <span class="nx">opspec</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><h4>Note</h4>

<p>Here I&#8217;m making use of the fact that JS engines today such as V8 always
enumerate the keys of an object in the order in which they were added to it.
This is what lets us identify the <em>first</em> key as determining the operation to
start with the operation implementation knowing what to make of the other
keys in the expression, the parameters and so on.</p>

<p>Also note that we&#8217;ve put in a pipeline here &#8211; i.e. <code>ask</code> gets a file name
that it passes as input to <code>fetchFile</code> which passes the fetched file data to
<code>spawn</code>, and so on. <code>spawn</code> is a higher order operation, since it takes an
operation as the argument to perform concurrently, while continuing by
passing its input through to <code>cacheInLocalStore</code>.</p></blockquote>

<p>Our framework, then, serves as an interpreter for this mini language, providing
the necessary abstractions on <em>how</em> we expect these operations to be executed
behind the scenes. What is important is that <em>users</em> of our framework are not
forced to think about browser shutdown/restart cases and can simply assume
that the infrastructure we provide will &#8220;do the right thing&#8221;.</p>

<p>Now, I&#8217;m not going to go into details of what one actually needs to do to
<em>implement</em> the shutdown/restart behaviour, but at this point, it ought to be
clear enough that given a serializable representation of &#8220;operations still left
to do&#8221; and a serializable representation of the input to give to this sequence,
we can dump both at any point to disk (plus some book keeping info) and resume
after a browser/server restart. We&#8217;ll need to do that for <em>each task sequence</em>
that&#8217;s active at the point the shutdown is initiated.</p>

<p>The important thing is that the one writing the script can focus on writing the
script instead of the operational details.</p>

<h2>Recap</h2>

<p>The main takeaways from this post are the following -</p>

<ol>
<li><p>If you find categories of objects in your problem domain that are closed
over a number of functions and you want to abstract away the constraints
under which those functions can be combined, you may find it useful to
create a DSL for your domain.</p></li>
<li><p>The consistent implementation of key enumeration order of objects in
Javascript engines allows us to write <strong>specifications of composeable
computations</strong> using generic JSON-serializable notation that we can call
&#8220;J-expressions&#8221;.</p>

<pre><code>{opname: main_parameter,
    keyword1: value1,
    keyword2: value2,
    ...}
</code></pre></li>
<li><p>J-expressions, in combination with functions that implement what the
operation named &#8220;opname&#8221; is supposed to do, are then a systematic way to
approach DSL construction within Javascript.  The notation is as expressive
as s-expressions. For instance, here is a way to write a &#8220;higher order
asop&#8221; :)</p>

<pre><code>{lambda_the_ultimate: ["arg"],
    do: [
        {step1: ..},
        {step2: ..}
    ]}
</code></pre></li>
</ol>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Srikumar</span></span>

      








  


<time datetime="2012-04-14T00:00:00+08:00" pubdate data-updated="true">Apr 14<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/javascript/'>Javascript</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://srikumarks.github.com/blog/2012/04/14/creating-dsls-in-javascript-using-j-expressions/" data-via="srikumarks" data-counturl="http://srikumarks.github.com/blog/2012/04/14/creating-dsls-in-javascript-using-j-expressions/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/04/13/a-mental-model-for-variables-and-closures-in-javascript/" title="Previous Post: A mental model for variables and closures in Javascript">&laquo; A mental model for variables and closures in Javascript</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/04/15/j-expressions/" title="Next Post: J-expressions">J-expressions &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/30/exploring-grha-bhedams/">Exploring graha bhedams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/27/scratch-pad-for-text-with-diacritics/">Scratch pad for text with diacritics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/09/a-critique-of-tuna/">A critique of Tuna</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/28/on-eval-being-evil/">On eval and evil.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/30/toy-language-using-j-expressions/">Toy language using j-expressions</a>
      </li>
    
  </ul>
</section>

<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/102694714835839603248?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("srikumarks", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/srikumarks" class="twitter-follow-button" data-show-count="false">Follow @srikumarks</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Srikumar -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
