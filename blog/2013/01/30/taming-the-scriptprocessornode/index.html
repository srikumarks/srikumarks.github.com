
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Taming the ScriptProcessorNode - Codaholic</title>
  <meta name="author" content="Srikumar">

  
  <meta name="description" content="The Web Audio API provides graph based API for audio generation and
processing primitives with a focus on high performance and low latency. For &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://srikumarks.github.com/blog/2013/01/30/taming-the-scriptprocessornode">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Codaholic" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Cantata+One' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30922656-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Codaholic</a></h1>
  
    <h2>Does the dog have Turing nature?</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:srikumarks.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/srikumarks">Github</a></li>
  <li><a href="/demos">Demos</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Taming the ScriptProcessorNode</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-30T21:20:00+05:30" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>The <a href="http://www.w3.org/TR/webaudio">Web Audio API</a> provides graph based API for audio generation and
processing primitives with a focus on high performance and low latency. For
custom processing that is not covered by the builtin native audio nodes, it
provides a <a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode">ScriptProcessorNode</a> whose processing is determined by a Javascript
function. Though the <a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode">ScriptProcessorNode</a> is presented like any other node
type by the API, its behaviour differs from the other native nodes in some
fundamental ways. This post examines some of these differences using a simple
chime model as the use case, and derives some suggestions for the <a href="http://www.w3.org/TR/webaudio">Web Audio API</a>
specification.</p>

<!-- more -->


<h4>Contents</h4>

<ol>
<li><a href="#simple-chime-model">A simple chime model</a></li>
<li><a href="#abstracting-chime-model">Abstracting the chime model</a></li>
<li><a href="#replacing-gain-node-with-scriptprocessornode">Replacing the gain node with a ScriptProcessorNode</a>

<ol>
<li><a href="#vanishing-script-node">Problem 1: The vanishing script node</a></li>
<li><a href="#eternal-script-node">Problem 2: The eternal script node</a></li>
</ol>
</li>
<li><a href="#replacing-oscillator-with-scriptprocessornode">Replacing the oscillator with a ScriptProcessorNode</a></li>
<li><a href="#accounting-for-tail-time">Accounting for tail time</a></li>
<li><a href="#reflections-on-api">Reflections on the API</a></li>
<li><a href="#concluding-suggestions">Concluding suggestions</a></li>
<li><a href="#stellers-jsnode-model">PS: Steller&#8217;s jsnode model</a></li>
</ol>


<h2><a name="simple-chime-model"></a>A simple chime model</h2>

<p>Let&#8217;s consider a simple kind of sound - a &#8220;chime&#8221;, a decaying sinusoid
oscillating at a given frequency. This can be implemented using an
<a href="http://www.w3.org/TR/webaudio/#OscillatorNode">OscillatorNode</a> and a <a href="http://www.w3.org/TR/webaudio/#GainNode">GainNode</a> as follows -</p>

<p><img src="/images/osc-gain.svg"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">AC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">webkitAudioContext</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
</span><span class='line'><span class="nx">osc</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createGainNode</span><span class="p">();</span>
</span><span class='line'><span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
</span><span class='line'><span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'><span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
</span><span class='line'><span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span><span class='line'><span class="nx">osc</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">);</span>
</span><span class='line'><span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mf">15.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code produces a single chime that lasts for about 10 seconds, with a
decay time constant of 2 seconds. Though this is not very useful as it stands,
it helps to illustrate a couple of aspects of nodes in the <a href="http://www.w3.org/TR/webaudio">Web Audio API</a>.</p>

<p>First, we see two types of nodes being used &#8211; a &#8220;source&#8221; node (the oscillator)
which generates a signal without needing an input, and a &#8220;processor&#8221; node (the
gain) which takes an input signal, does something with it and sends a modified
signal to its output.</p>

<p>Second, we see a time limited triggering of the <a href="http://www.w3.org/TR/webaudio/#OscillatorNode">OscillatorNode</a>. The node is
triggered 5 seconds into the future and is stopped 10 seconds after it starts.
The way the <a href="http://www.w3.org/TR/webaudio">Web Audio API</a> is designed, once the oscillator node has stopped,
it becomes rather useless and needs to be discarded. This is because start/stop
can be used only once on source nodes. Therefore when using an <a href="http://www.w3.org/TR/webaudio/#OscillatorNode">OscillatorNode</a>
as in this example, the references to <code>osc</code> and <code>gain</code> are no longer necessary
and we can add the following lines at the end of the above code block.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">osc</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'><span class="nx">gain</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>With no references holding the oscillator and gain nodes from garbage collection,
one might think that they might be destroyed soon after the references are
given up, before the oscillator gets a chance to generate any sound. Fortunately,
the oscillator holds a reference to itself until its stop time is reached,
after which the reference is released and the subgraph between the source and the
context destination is destroyed. This behaviour of native source nodes is
documented in the <a href="http://www.w3.org/TR/webaudio/#DynamicLifetime">Dynamic Lifetime</a> section of the <a href="http://www.w3.org/TR/webaudio">Web Audio API</a> documentation.</p>

<h2><a name="abstracting-chime-model"></a>Abstracting the chime model</h2>

<p>The chime model described in the previous section only plays one chime. This is
practically useless in the real world. A more useful incarnation of the chime model
would permit us to trigger a chime at any time we want and at any frequency
we want as well. The model manages the nodes necessary for its function
purely internally.</p>

<p><img src="/images/chime.svg"></p>

<p>This is easily encapsulated as a function &#8211;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">AC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">webkitAudioContext</span><span class="p">();</span> <span class="c1">// We&#39;ll assume this here onwards.</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">chime</span><span class="p">(</span><span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">freq</span> <span class="o">||</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createGainNode</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span> <span class="o">||</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// References to osc and gain are given up</span>
</span><span class='line'>    <span class="c1">// upon return from chime().</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a name="replacing-gain-node-with-scriptprocessornode"></a>Replacing the gain node with a ScriptProcessorNode</h2>

<p>Now let&#8217;s consider what happens if we try to replace the gain node&#8217;s behaviour
(limited to this example) using a <a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode">ScriptProcessorNode</a>.</p>

<figure class='code'><figcaption><span><a name="chime_jsgain">chime_jsgain</a> A straightforward replacement of the gain node with a script node.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">AC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">webkitAudioContext</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">chime_jsgain</span><span class="p">(</span><span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">freq</span> <span class="o">||</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">amplitude</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">decay</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">N</span><span class="p">,</span> <span class="nx">inp</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">inp</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">out</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">N</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">amplitude</span> <span class="o">*=</span> <span class="nx">decay</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">amplitude</span> <span class="o">*</span> <span class="nx">inp</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}());</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span> <span class="o">||</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a name="vaninshing-script-node"></a>Problem 1: The vanishing script node</h3>

<p>If you try to make a chime using <a href="#chime_jsgain">chime_jsgain</a>, you&#8217;ll find
that the sound stops abruptly well before the 10 seconds duration given.  This
is because the script node is garbage collected almost immediately.  This is
a <a href="https://code.google.com/p/chromium/issues/detail?id=82795">WebKit implementation bug</a>. The oscillator node, which has a
persistent reference till stop time, holds a reference to the script node
through its output, and yet the script node is garbage collected. A known
workaround for this bug is to maintain a <em>global</em> reference to the script node.
For this, we can use the following simple scheme &#8211;</p>

<p><em>edit</em>: Added link to issue.</p>

<figure class='code'><figcaption><span><a name="keep">keep</a> Preserving script nodes.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">scriptNodes</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">keep</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">nextNodeID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">node</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="p">(</span><span class="nx">nextNodeID</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">scriptNodes</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the <code>keep</code> utility, we can now rewrite <code>chime_jsnode</code> as &#8211;</p>

<figure class='code'><figcaption><span>Keeping around a global reference to the script node.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">chime_jsgain</span><span class="p">(</span><span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">keep</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will result in the script node being preserved during the course of
the chime.</p>

<h3><a name="eternal-script-node"></a>Problem 2: The eternal script node</h3>

<p>With the modifications of the preceding section, the oscillator node will
disappear after 10 seconds but the script node will persist and continue to be
processed. To prevent this, we make arrangement for the script node to be
removed from the graph and for its global reference to be dropped once it has
processed enough samples.</p>

<figure class='code'><figcaption><span><a name="drop">drop</a> Dropping the global reference to a node.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">drop</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">delete</span> <span class="nx">scriptNodes</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We incorporate the new <code>drop</code> function into <code>chime_jsnode</code> as follows &#8211;</p>

<figure class='code'><figcaption><span>A script implementation of gain node with proper end of life management.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">chime_jsgain</span><span class="p">(</span><span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">freq</span> <span class="o">||</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">keep</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">amplitude</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">decay</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">));</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">stopTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">N</span><span class="p">,</span> <span class="nx">inp</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">finished</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span><span class="p">;</span> <span class="c1">// Don&#39;t do anything after stopTime has elapsed.</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">inp</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">out</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Limit the number of samples we compute.</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">now_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">N</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">stopTime_samples</span> <span class="o">-</span> <span class="nx">now_samples</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">amplitude</span> <span class="o">*=</span> <span class="nx">decay</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">amplitude</span> <span class="o">*</span> <span class="nx">inp</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">N</span> <span class="o">&lt;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Reached end time before end of buffer.</span>
</span><span class='line'>                <span class="nx">finished</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">drop</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
</span><span class='line'>                    <span class="nx">osc</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>                    <span class="nx">gain</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>                <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}());</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span> <span class="o">||</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We now have a script node based implementation that works like the native
implementation in all respects. This kind of &#8220;stop time&#8221; behaviour can be
lifted into a separate function that transforms a <code>function (event, toSamp) {...}</code>
into an <code>onaudioprocess</code> handler.</p>

<figure class='code'><figcaption><span><a name="scriptWithStopTime">scriptWithStopTime</a> End of life management of script nodes.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">scriptWithStopTime</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">keep</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">node</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">finished</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">toSamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">stopTime_samples</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">handler</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">toSamp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">toSamp</span> <span class="o">&lt;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">finished</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">drop</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>            <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using <a href="#scriptWithStopTime">scriptWithStopTime</a>, we can now rewrite <code>chime_jsgain</code> as &#8211;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">chime_jsgain</span><span class="p">(</span><span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">freq</span> <span class="o">||</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">scriptWithStopTime</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">amplitude</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">decay</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">N</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">inp</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">inp</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">out</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">amplitude</span> <span class="o">*=</span> <span class="nx">decay</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">amplitude</span> <span class="o">*</span> <span class="nx">inp</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}()));</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span> <span class="o">||</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a name="replacing-oscillator-with-scriptprocessornode"></a>Replacing the oscillator with a ScriptProcessorNode</h2>

<p>Now, let&#8217;s consider what happens if we try to implement the <a href="http://www.w3.org/TR/webaudio/#OscillatorNode">OscillatorNode</a>
(limited to this example) using a <a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode">ScriptProcessorNode</a>. We can use
<a href="#scriptWithStopTime">scriptWithStopTime</a> to take a first shot at it.
While we&#8217;re there, we&#8217;ll also generalize the chime model to take a time
at which to trigger the chime.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">chimeJS</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">freq</span> <span class="o">=</span> <span class="nx">freq</span> <span class="o">||</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">t</span> <span class="o">||</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">scriptWithStopTime</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">phi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dphi</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">freq</span> <span class="o">/</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">N</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">out</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">phi</span> <span class="o">+=</span> <span class="nx">dphi</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}()));</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createGainNode</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setValueAtTime</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">gain</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span> <span class="o">||</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Exposing the start time makes obvious a few design flaws &#8211;</p>

<ol>
<li><p>If you schedule a chime into the future instead of &#8220;right now&#8221;,
the script node oscillator will keep running from &#8220;right now&#8221; until
the end. The period from &#8220;now&#8221; to the scheduled start time is all
wasted computation.</p></li>
<li><p>The node responsible for the chime starting on time is the <code>gain</code>
node. Since the oscillator is continuously running, the phase at
which the oscillator begins will depend on the time passed in,
but ideally we want the oscillator to start with phase 0 when
the chime starts .. and we want it to be sample accurate.</p></li>
</ol>


<p>To solve the wasted computation problem, we can make the <code>onaudioprocess</code>
be a no-op until the start time. This is best done by writing a
<code>scriptWithStartStopTime</code> as we did with <code>scriptWithStopTime</code>.</p>

<figure class='code'><figcaption><span><a name="scriptWithStartStopTime2">scriptWithStartStopTime</a> Removing wasted computation.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">scriptWithStartStopTime</span><span class="p">(</span><span class="nx">startTime</span><span class="p">,</span> <span class="nx">stopTime</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">stopTime</span> <span class="o">&gt;=</span> <span class="nx">startTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">keep</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">startTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">startTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">node</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">finished</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">fromSamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">startTime_samples</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">fromSamp</span> <span class="o">&gt;=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Not started yet.</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">toSamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">stopTime_samples</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Handler signature changed to include both start and stop indices.</span>
</span><span class='line'>        <span class="nx">handler</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fromSamp</span><span class="p">,</span> <span class="nx">toSamp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">toSamp</span> <span class="o">&lt;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">finished</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">drop</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>            <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above version saves <em>some</em> computation but not all. The JS node does not
need to receive any callbacks whatsoever until it is time to start generating
samples. To achieve this, we need to schedule the node to connect and start
just in time, say 0.1 seconds before the scheduled start time. To do this,
we need to generalize <code>scriptWithStartStopTime</code> to work with the nodes
to which the script node is expected to connect.</p>

<figure class='code'><figcaption><span><a name="scriptWithStartStopTime2">scriptWithStartStopTime</a> Delayed node setup.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">scriptWithStartStopTime</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">startTime</span><span class="p">,</span> <span class="nx">stopTime</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">startTime</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">stopTime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">stopTime</span> <span class="o">&gt;=</span> <span class="nx">startTime</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">kBufferLength</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="c1">// samples</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">prepareAheadTime</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="c1">// seconds</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">startTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">startTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">onaudioprocess</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">finished</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">fromSamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">startTime_samples</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">fromSamp</span> <span class="o">&gt;=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span> <span class="c1">// Not started yet.</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">toSamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">stopTime_samples</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Handler signature changed to include both start and stop indices.</span>
</span><span class='line'>        <span class="nx">handler</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fromSamp</span><span class="p">,</span> <span class="nx">toSamp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">toSamp</span> <span class="o">&lt;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">finished</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">drop</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">input</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>            <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">prepareNode</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">keep</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">(</span><span class="nx">kBufferLength</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>        <span class="nx">node</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="nx">onaudioprocess</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Setup the necessary connections.</span>
</span><span class='line'>        <span class="nx">input</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">output</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">dt</span> <span class="o">=</span> <span class="nx">startTime</span> <span class="o">-</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dt</span> <span class="o">&lt;=</span> <span class="nx">prepareAheadTime</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">prepareNode</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">prepareNode</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="nx">dt</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use <code>scriptWithStartStopTime</code> to include such dynamically determined
source or processing nodes within a subgraph &#8230; except when two such nodes
need to be connected to each other and both remain unrealized for a while. In
such cases, we can use an intermediate unity gain node for simplicity. Here
then is our final chime model with a js node for the gain or the oscillator.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">chime_jsosc</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">freq</span> <span class="o">=</span> <span class="nx">freq</span> <span class="o">||</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">t</span> <span class="o">||</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createGainNode</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setValueAtTime</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">gain</span><span class="p">.</span><span class="nx">setTargetAtTime</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">gain</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span> <span class="o">||</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">scriptWithStartStopTime</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">gain</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stopTime</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">phi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dphi</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">freq</span> <span class="o">/</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fromSamp</span><span class="p">,</span> <span class="nx">toSamp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">out</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">fromSamp</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">toSamp</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">phi</span> <span class="o">+=</span> <span class="nx">dphi</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}()));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">chime_jsgain</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">freq</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">freq</span> <span class="o">=</span> <span class="nx">freq</span> <span class="o">||</span> <span class="mf">880.0</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">t</span> <span class="o">||</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">output</span> <span class="o">=</span> <span class="nx">output</span> <span class="o">||</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">osc</span> <span class="o">=</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">createOscillator</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">frequency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">freq</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gain</span> <span class="o">=</span> <span class="nx">scriptWithStartStopTime</span><span class="p">(</span><span class="nx">osc</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stopTime</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">amplitude</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">decay</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fromSamp</span><span class="p">,</span> <span class="nx">toSamp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">inp</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">inp</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">inputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">out</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">fromSamp</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">toSamp</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">amplitude</span> <span class="o">*=</span> <span class="nx">decay</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">amplitude</span> <span class="o">*</span> <span class="nx">inp</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}()));</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">osc</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a name="accounting-for-tail-time"></a>Accounting for tail time</h2>

<p>The gain node is simple in that it produces one output sample for each input
sample it receives on its input pin. Other node types, especially filter and
convolution nodes, may &#8220;tail off&#8221; well after the input to these nodes has
ceased. In other words, the true stop time of a node at which the node is
free to be garbage collected is at the end of such a tail time, which may
be only known when the node is running.</p>

<p>A simple way to account for this is to have the handler passed to
<code>scriptWithStartStopTime</code> use the <code>toSamp</code> argument only for information and
return the number of samples it actually produced. If the handler has produced
samples up to the buffer&#8217;s capacity, then it cannot be stopped.  If it stopped
somewhere before the end of the buffer, then it can be taken to be finished and
cleanup can be triggered. This logic can be expressed in a modified
<code>scriptWithStartStopTime</code> as shown below &#8211;</p>

<figure class='code'><figcaption><span><a name="final-scriptWithStartStopTime">scriptWithStartStopTime</a> Supporting tail time.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">scriptWithStartStopTime</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">startTime</span><span class="p">,</span> <span class="nx">stopTime</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">startTime</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">stopTime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">stopTime</span><span class="p">,</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">stopTime</span> <span class="o">&gt;=</span> <span class="nx">startTime</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">kBufferLength</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="c1">// samples</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">prepareAheadTime</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="c1">// seconds</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">startTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">startTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stopTime_samples</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="nx">stopTime</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">onaudioprocess</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">finished</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">*</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">fromSamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">startTime_samples</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">fromSamp</span> <span class="o">&gt;=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span> <span class="c1">// Not started yet.</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">toSamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">stopTime_samples</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Return value of handler is used to decide when to stop. The handler is</span>
</span><span class='line'>        <span class="c1">// required to produce as many samples as possible. If it still can&#39;t fill</span>
</span><span class='line'>        <span class="c1">// up the buffer, it is deemed to have finished.</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">samplesProduced</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fromSamp</span><span class="p">,</span> <span class="nx">toSamp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">fromSamp</span> <span class="o">+</span> <span class="nx">samplesProduced</span> <span class="o">&lt;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">finished</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">drop</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">input</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">event</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span><span class='line'>            <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">prepareNode</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">keep</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">createScriptProcessor</span><span class="p">(</span><span class="nx">kBufferLength</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>        <span class="nx">node</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="nx">onaudioprocess</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Setup the necessary connections.</span>
</span><span class='line'>        <span class="nx">input</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">output</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">dt</span> <span class="o">=</span> <span class="nx">startTime</span> <span class="o">-</span> <span class="nx">AC</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dt</span> <span class="o">&lt;=</span> <span class="nx">prepareAheadTime</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">prepareNode</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">prepareNode</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="nx">dt</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a name="reflections-on-api"></a>Reflections on the API</h2>

<p>The <a href="#final-scriptWithStartStopTime">final form of scriptWithStartStopTime</a>
expresses functionality that is essential to the use of script nodes as
algorithmic signal sources and signal processors that can be scheduled
to sample accuracy. Although this function adds the required functionality,
the <a href="http://www.w3.org/TR/webaudio">Web Audio API</a> would be better off with a script node type whose
lifetime can be managed just like the native nodes and suppor the
dynamic behaviour available with the native nodes.</p>

<p>Not having it builtin results in an inconsistency that is awkward to
work around - the fact that <code>start(t)</code> and <code>stop(t)</code> methods added in pure
Javascript are not only necessary for script nodes that are pure signal
generators, but also for signal processors. This is because a script node might
otherwise end up wasting compute cycles either idling or computing audio that
is going to be discarded by the rest of the chain. A <code>stop(t)</code> method is
necessary for such processor nodes because the <a href="http://www.w3.org/TR/webaudio">Web Audio API</a> does not
currently provide any notification mechanisms for monitoring connections to a
node&#8217;s input and output so that processor nodes can self destruct when their
inputs die.</p>

<h2><a name="concluding-suggestions"></a>Concluding suggestions</h2>

<p>The use case worked through in this post demonstrates how abstractions built on
other nodes do not extend to script nodes without special considerations. The
two kinds of usages for script nodes discussed here &#8211; sources and signal
processors &#8211; are common scenarios. Having the following features built into
the <a href="http://www.w3.org/TR/webaudio/#ScriptProcessorNode">ScriptProcessorNode</a> helps avoid the problems that crop up in
straightfoward usage of script nodes.</p>

<ol>
<li>Permit creation of script nodes without inputs. This better models source
nodes. Passing 0 for &#8220;number of input channels&#8221; may be enough at the API
level.</li>
<li>Add <code>start(t)</code> and <code>stop(t)</code> methods to permit script nodes to be used as
signal sources, with such nodes not taking up any system resources during
their inactive periods.</li>
<li>Add <a href="http://www.w3.org/TR/webaudio/#DynamicLifetime">dynamic lifetime</a> support similar to native nodes, whereby unreferenced
&#8220;signal processor&#8221; script nodes driven by source nodes are automatically
released once the source node finishes, even if the source node is itself a
script node. To achieve this, the time at which the inputs cease must be
available as part of the event structure passed to the <code>onaudioprocess</code>
callback, so that the callback can begin any tail phase that it needs to
complete before it commits suicide.</li>
<li>Specify a convention and/or API to support tail times beyond
the time indicated in a stop(t) call or after its inputs have
been end-of-lifed.</li>
</ol>


<h3><a name="stellers-jsnode-model"></a>PS: Steller&#8217;s jsnode model</h3>

<p>The <a href="https://github.com/srikumarks/steller">Steller</a> library features a <a href="https://github.com/srikumarks/steller/blob/experimental_buildsys/src/models/jsnode.js">jsnode</a> model that wraps the API&#8217;s script
node into a node type that can be scheduled as discussed in this post. It also
adds some conveniences such as multiple inputs (albeit single channel), and
a-rate controllable and schedulable <a href="http://www.w3.org/TR/webaudio/#AudioParam">AudioParam</a> parameters. You can use
Steller&#8217;s jsnode model like this -</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://sriku.org/lib/steller/steller.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">sh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">org</span><span class="p">.</span><span class="nx">anclab</span><span class="p">.</span><span class="nx">steller</span><span class="p">.</span><span class="nx">Scheduler</span><span class="p">(</span><span class="k">new</span> <span class="nx">webkitAudioContext</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">jsn</span> <span class="o">=</span> <span class="nx">sh</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">jsnode</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">numberOfInputs</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">numberOfOutputs</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">onaudioprocess</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// ...</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">toSamp</span> <span class="o">-</span> <span class="nx">fromSamp</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}});</span>
</span><span class='line'>    <span class="nx">jsn</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">AC</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">sh</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="nx">sh</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">clock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">jsn</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">clock</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">jsn</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">clock</span><span class="p">.</span><span class="nx">t</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Srikumar</span></span>

      








  


<time datetime="2013-01-30T21:20:00+05:30" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/javascript/'>Javascript</a>, <a class='category' href='/blog/categories/web-audio-api/'>Web Audio API</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://srikumarks.github.com/blog/2013/01/30/taming-the-scriptprocessornode/" data-via="srikumarks" data-counturl="http://srikumarks.github.com/blog/2013/01/30/taming-the-scriptprocessornode/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/12/30/exploring-grha-bhedams/" title="Previous Post: Exploring graha bhedams">&laquo; Exploring graha bhedams</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/03/13/tala-keeper-1-dot-3-0-released/" title="Next Post: Tala Keeper 1.3.0 released">Tala Keeper 1.3.0 released &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/13/tala-keeper-1-dot-3-0-released/">Tala Keeper 1.3.0 released</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/30/taming-the-scriptprocessornode/">Taming the ScriptProcessorNode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/30/exploring-grha-bhedams/">Exploring graha bhedams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/27/scratch-pad-for-text-with-diacritics/">Scratch pad for text with diacritics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/09/a-critique-of-tuna/">A critique of Tuna</a>
      </li>
    
  </ul>
</section>

<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/102694714835839603248?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("srikumarks", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/srikumarks" class="twitter-follow-button" data-show-count="false">Follow @srikumarks</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Srikumar -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
